<!DOCTYPE html>
<html>
<head>
    <title>AI Game Recs</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background: #121212; color: white; }
        #recordBtn { padding: 20px 40px; font-size: 20px; cursor: pointer; border-radius: 50px; border: none; background: #ff4b2b; color: white; }
        #recordBtn.recording { background: #333; }
        #results { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>üéÆ Steam AI Recommender</h1>
    <p>Tell me what kind of game you're in the mood for!</p>
    
    <button id="recordBtn">üé§ Hold to Speak</button>
    
    <div id="results">
        <h3 id="transcription"></h3>
        <div id="gameList"></div>
    </div>

    <script>
    let mediaRecorder;
    let audioChunks = [];
    const btn = document.getElementById('recordBtn');

    // üé§ Fix: Use async/await properly for mic access
    btn.onmousedown = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;
            
            mediaRecorder.start();
            btn.innerText = "Listening...";
            btn.classList.add('recording');
        } catch (err) {
            console.error("Mic access denied or error:", err);
            alert("Could not access microphone. Please check browser permissions.");
        }
    };

    btn.onmouseup = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            btn.innerText = "üé§ Hold to Speak";
            btn.classList.remove('recording');
        }
    };

    async function sendAudio() {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const formData = new FormData();
        formData.append('file', audioBlob, 'audio.wav');

        const response = await fetch('/recommend', { method: 'POST', body: formData });
        const data = await response.json();
        
        document.getElementById('transcription').innerText = "You said: " + data.transcription;
        
        const listDiv = document.getElementById('gameList');
        listDiv.innerHTML = ""; 

        // üéØ Fix: Mapping the rich recommendation objects
        data.recommendations.forEach(game => {
            const item = document.createElement('div');
            item.innerHTML = `
                <div style="background: #1e1e1e; padding: 15px; margin: 10px; border-radius: 8px; border: 1px solid #333; text-align: left;">
                    <h2 style="margin: 0;">
                        <a href="${game.link}" target="_blank" style="color: #ff4b2b; text-decoration: none;">${game.name}</a>
                    </h2>
                    <p style="color: #888; font-size: 0.9em;">Tags: ${game.tags.join(', ')}</p>
                    <button onclick="trainAI(${game.appid})" style="background: #444; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-top: 5px;">üëç Like (Train AI)</button>
                </div>
            `;
            listDiv.appendChild(item);
        });
    }

    async function trainAI(appid) {
        const response = await fetch('/like_game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ appid: appid })
        });
        const result = await response.json();
        alert(result.status);
    }    
</script>
</body>
</html>